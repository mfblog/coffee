name: Deploy to Windows Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH to Windows Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            powershell -Command "
              $ErrorActionPreference = 'Stop'
              try {
                Write-Host 'ğŸ’» Connecting to server...'
                Set-Location 'C:\websites\brew-guide'
                
                Write-Host 'ğŸ“‚ Current location:'
                Get-Location
                
                Write-Host 'ğŸ‘¤ Current user:'
                $env:USERNAME
                
                Write-Host 'ğŸ“ Writing deploy log...'
                Add-Content -Path 'C:\websites\brew-guide\deploy-log.txt' -Value ('âœ… Deploy triggered via GitHub Actions at ' + (Get-Date -Format 'yyyy-MM-dd HH:mm:ss'))
                
                Write-Host 'ğŸ”’ Configuring Git...'
                git config --global --add safe.directory 'C:/websites/brew-guide'
                
                # é…ç½® Git ä½¿ç”¨æ­£ç¡®çš„ SSH å¯†é’¥
                $env:GIT_SSH_COMMAND = 'ssh -i C:/Users/Administrator/.ssh/id_ed25519 -o StrictHostKeyChecking=no'
                
                Write-Host 'ğŸ§¹ Cleaning Git working directory...'
                git reset --hard HEAD
                git clean -fd
                
                Write-Host 'ğŸ”„ Fetching latest changes...'
                git fetch origin main
                
                Write-Host 'ğŸ“¥ Pulling latest code...'
                git pull origin main
                if ($LASTEXITCODE -ne 0) {
                  throw 'Git pull failed'
                }
                
                Write-Host 'ğŸ›‘ Stopping app via PM2...'
                $env:PM2_HOME = 'C:\pm2'
                pm2 stop brew-guide
                
                Write-Host 'ğŸ“¦ Installing dependencies...'
                npm install --no-audit --no-fund
                if ($LASTEXITCODE -ne 0) {
                  throw 'npm install failed'
                }
                
                Write-Host 'ğŸ”¨ Building project...'
                npm run build
                if ($LASTEXITCODE -ne 0) {
                  throw 'npm build failed'
                }
                
                Write-Host 'ğŸš€ Restarting app...'
                pm2 restart brew-guide
                
                Write-Host 'âœ… Deploy completed successfully at ' (Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
                Add-Content -Path 'C:\websites\brew-guide\deploy-log.txt' -Value ('âœ… Deploy completed successfully at ' + (Get-Date -Format 'yyyy-MM-dd HH:mm:ss'))
              }
              catch {
                Write-Error ('âŒ Deploy failed: ' + $_.Exception.Message)
                Add-Content -Path 'C:\websites\brew-guide\deploy-log.txt' -Value ('âŒ Deploy failed at ' + (Get-Date -Format 'yyyy-MM-dd HH:mm:ss') + ': ' + $_.Exception.Message)
                exit 1
              }
            "
