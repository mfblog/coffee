name: Deploy to Windows Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH to Windows Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          powershell -Command "
            Write-Host 'ğŸ’» Connecting to server...';
            cd 'C:\websites\brew-guide';

            Write-Host 'ğŸ”§ Fetching latest code from origin/main...';
            git fetch origin main;
            git reset --hard origin/main;

            Write-Host 'ğŸ”’ Marking directory as safe...';
            git config --global --add safe.directory 'C:/websites/brew-guide';

            Write-Host 'ğŸ›‘ Stopping app with PM2...';
            pm2 stop brew-guide;

            Write-Host 'ğŸ“¦ Installing dependencies...';
            npm install;

            Write-Host 'ğŸ”¨ Building project...';
            npm run build;

            Write-Host 'ğŸš€ Restarting app with PM2...';
            pm2 restart brew-guide;

            Write-Host 'ğŸ“ Writing deploy timestamp...';
            Set-Content -Path 'C:\websites\brew-guide\__last_deploy.txt' -Value \"Deployed at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\";

            Write-Host 'âœ… Deployment finished.';
          "
