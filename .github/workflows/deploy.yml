name: Deploy to Windows Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

<<<<<<< HEAD
    - name: Deploy via SSH to Windows Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          powershell -Command "
            Write-Host 'ğŸ’» Connecting to server...';
            cd 'C:\websites\brew-guide';

            Write-Host 'ğŸ”§ Fetching latest code from origin/main...';
            git fetch origin main;
            git reset --hard origin/main;
            git status;  # Add this line to check if repository is up-to-date

            Write-Host 'ğŸ”’ Marking directory as safe...';
            git config --global --add safe.directory 'C:/websites/brew-guide';

            Write-Host 'ğŸ›‘ Stopping app with PM2...';
            pm2 stop brew-guide || Write-Host 'Failed to stop PM2 process';

            Write-Host 'ğŸ“¦ Installing dependencies...';
            npm install || Write-Host 'npm install failed';

            Write-Host 'ğŸ”¨ Building project...';
            npm run build || Write-Host 'npm build failed';

            Write-Host 'ğŸš€ Restarting app with PM2...';
            pm2 restart brew-guide || Write-Host 'Failed to restart PM2 process';

            Write-Host 'ğŸ“ Writing deploy timestamp...';
            Set-Content -Path 'C:\websites\brew-guide\__last_deploy.txt' -Value \"Deployed at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\";

            Write-Host 'âœ… Deployment finished.';
            ";
=======
      - name: Deploy via SSH to Windows Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            powershell -Command "
              # è®¾ç½®é”™è¯¯å¤„ç†
              $ErrorActionPreference = 'Stop'
              $ProgressPreference = 'SilentlyContinue'
              
              # åˆ›å»ºæ—¥å¿—ç›®å½•
              $logDir = 'C:\websites\brew-guide\logs'
              New-Item -ItemType Directory -Force -Path $logDir
              
              # æ—¥å¿—å‡½æ•°
              function Write-DeployLog {
                param($Message)
                $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
                Write-Host "$timestamp - $Message"
                Add-Content -Path "$logDir\deploy.log" -Value "$timestamp - $Message"
              }
              
              try {
                Write-DeployLog 'å¼€å§‹éƒ¨ç½²æµç¨‹'
                
                # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
                Set-Location 'C:\websites\brew-guide'
                Write-DeployLog "å½“å‰ç›®å½•: $(Get-Location)"
                
                # Git æ“ä½œ
                Write-DeployLog 'é…ç½® Git å®‰å…¨ç›®å½•'
                git config --global --add safe.directory 'C:/websites/brew-guide'
                
                Write-DeployLog 'ä¿å­˜ Git çŠ¶æ€'
                git status | Tee-Object -FilePath "$logDir\git-status-before.log"
                
                Write-DeployLog 'æ‹‰å–æœ€æ–°ä»£ç '
                git fetch origin main
                git reset --hard origin/main
                git clean -fd
                git status | Tee-Object -FilePath "$logDir\git-status-after.log"
                
                # NPM æ“ä½œ
                Write-DeployLog 'å®‰è£…ä¾èµ–'
                npm ci --no-audit --no-fund | Tee-Object -FilePath "$logDir\npm-install.log"
                
                Write-DeployLog 'æ„å»ºé¡¹ç›®'
                npm run build | Tee-Object -FilePath "$logDir\npm-build.log"
                
                # PM2 æ“ä½œ
                Write-DeployLog 'é‡å¯åº”ç”¨'
                $env:PM2_HOME = 'C:\pm2'
                pm2 restart brew-guide
                
                Write-DeployLog 'éƒ¨ç½²å®Œæˆ'
              } catch {
                Write-DeployLog "é”™è¯¯: $_"
                Write-DeployLog $_.ScriptStackTrace
                throw $_
              }
            "

      - name: Check deployment logs
        uses: appleboy/ssh-action@master
        if: always()
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            powershell -Command "
              if (Test-Path 'C:\websites\brew-guide\logs\deploy.log') {
                Get-Content 'C:\websites\brew-guide\logs\deploy.log'
              } else {
                Write-Host 'éƒ¨ç½²æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨'
              }
            "
>>>>>>> 6634308 (ä¼˜åŒ–éƒ¨ç½²è„šæœ¬ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—å’Œé”™è¯¯å¤„ç†)
